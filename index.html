<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GOP Request App</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --primary: #0445AF;
            --primary-dark: #03368a;
            --bg: #fafafa;
            --text: #1d1d1f;
            --text-light: #86868b;
            --border: #d2d2d7;
            --error: #e02020;
            --card-bg: #ffffff;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            height: 100dvh;
            overflow: hidden;
        }

        .app-container {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .screen {
            display: none;
            flex: 1;
            flex-direction: column;
            padding: 24px;
            height: 100%;
            overflow-y: auto;
        }
        .screen.active { display: flex; }

        /* Header & Lang Toggle */
        .header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .lang-toggle {
            background: #fff; border: 1px solid var(--border);
            padding: 8px 12px; border-radius: 20px;
            font-size: 1.2rem; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: 0.2s;
        }
        .lang-toggle:active { transform: scale(0.95); }

        h1 { font-size: 1.8rem; font-weight: 600; color: var(--primary); margin: 0 0 8px 0; }
        h2 { font-size: 1.5rem; font-weight: 400; margin: 0 0 10px 0; color: var(--text); }
        .sub-text { font-size: 1rem; color: var(--text-light); display: block; margin-bottom: 25px; line-height: 1.5; }
        
        /* Inputs */
        .tf-input-group { width: 100%; margin-bottom: 10px; }
        input[type="text"], input[type="email"], input[type="tel"], input[type="date"], select {
            width: 100%; background: transparent; border: none;
            border-bottom: 2px solid var(--border); font-size: 1.5rem;
            padding: 8px 0; border-radius: 0; color: var(--primary);
            outline: none; transition: border-color 0.3s; font-family: 'Inter', sans-serif;
        }
        /* Special styling for the Clinic Dropdown */
        select.clinic-dropdown {
            font-size: 1.2rem;
            white-space: pre-wrap;
            text-overflow: ellipsis;
        }
        select.clinic-dropdown optgroup { font-size: 1rem; color: #333; font-style: normal; font-weight: 600; }
        
        input:focus, select:focus { border-color: var(--primary); }
        input::placeholder { color: #d2d2d7; }

        /* Phone */
        .phone-row { display: flex; gap: 15px; align-items: flex-end; }
        .phone-select {
            border: none; border-bottom: 2px solid var(--border);
            background: transparent; font-size: 1.2rem; padding: 8px 0;
            width: 100px; color: var(--text); border-radius: 0;
        }

        /* Profile Cards */
        .profile-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 16px; margin-top: 10px; padding-bottom: 40px;
        }
        .profile-card {
            background: var(--card-bg); border: 1px solid var(--border);
            border-radius: 16px; padding: 24px 16px; text-align: center;
            cursor: pointer; transition: all 0.2s ease; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 180px;
        }
        .profile-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        
        /* Profile Actions (Edit/Delete) */
        .card-actions {
            position: absolute; top: 10px; right: 10px; display: flex; gap: 8px;
        }
        .action-icon {
            width: 28px; height: 28px; border-radius: 50%;
            background: #f0f0f0; color: #666; display: flex;
            align-items: center; justify-content: center; font-size: 14px;
            transition: 0.2s; z-index: 5;
        }
        .action-icon:hover { background: var(--primary); color: white; }
        .action-icon.delete:hover { background: var(--error); color: white; }

        .profile-icon { font-size: 42px; margin-bottom: 12px; }
        .profile-name { font-weight: 600; font-size: 1rem; margin-bottom: 4px; word-break: break-word; }
        .profile-role { font-size: 0.8rem; color: var(--text-light); }
        .add-card { border-style: dashed; color: var(--text-light); }

        /* Admin Icon Grid */
        .icon-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; max-width: 400px; }
        .icon-opt {
            background: white; border: 2px solid var(--border); border-radius: 12px;
            padding: 15px; display: flex; justify-content: center; align-items: center;
            font-size: 32px; cursor: pointer; transition: 0.2s; color: var(--text-light); height: 80px;
        }
        .icon-opt.selected { border-color: var(--primary); color: var(--primary); background: #f0f7ff; }

        /* Slide Engine */
        .slide-viewer { flex: 1; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .slide { display: none; opacity: 0; transform: translateY(20px); transition: opacity 0.4s ease, transform 0.4s ease; }
        .slide.active { display: block; opacity: 1; transform: translateY(0); }

        /* Nav */
        .nav-bar {
            padding: 16px 24px; background: white; border-top: 1px solid #f0f0f0;
            display: flex; justify-content: space-between; align-items: center; z-index: 10;
        }
        .btn {
            background: var(--primary); color: white; border: none;
            padding: 12px 24px; border-radius: 6px; font-size: 1rem; font-weight: 500;
            cursor: pointer; display: flex; align-items: center; gap: 8px;
        }
        .btn-ghost { background: transparent; color: var(--text-light); padding: 12px 16px; }

        /* Summary */
        .summary-box {
            background: white; border: 1px solid var(--border); border-radius: 12px;
            padding: 20px; margin-bottom: 24px; max-height: 40vh; overflow-y: auto;
        }
        .summary-row {
            display: flex; flex-direction: column; margin-bottom: 16px;
            border-bottom: 1px solid #f5f5f7; padding-bottom: 12px;
        }
        .summary-row:last-child { border-bottom: none; }
        .summary-label { font-size: 0.75rem; text-transform: uppercase; color: var(--text-light); margin-bottom: 4px; }
        .summary-val { font-size: 1rem; font-weight: 500; color: var(--text); }

        .action-stack { display: flex; flex-direction: column; gap: 12px; }
        .btn-action { width: 100%; justify-content: center; padding: 16px; }
        .btn-whatsapp { background-color: #25D366; }
        .btn-copy { background-color: #f5f5f7; color: var(--primary); }
        
        .map-helper { font-size: 0.9rem; color: var(--primary); margin-top: 12px; display: inline-flex; align-items: center; gap: 6px; text-decoration: none; }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; border-bottom-color: var(--error) !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body>

    <div class="app-container">
        
        <div id="screen-home" class="screen active">
            <div class="header-row">
                <div>
                    <h1 id="lbl-title">GOP Request</h1>
                    <p class="sub-text" id="lbl-subtitle">Select an Administrator to begin.</p>
                </div>
                <button class="lang-toggle" onclick="app.toggleLang()">ENG / PT</button>
            </div>
            
            <div id="profile-list" class="profile-grid"></div>
        </div>

        <div id="screen-runner" class="screen">
            <div style="height: 4px; background: #f0f0f0; position: absolute; top: 0; left: 0; right: 0;">
                <div id="progress-bar" style="height: 100%; background: var(--primary); width: 0%; transition: width 0.3s;"></div>
            </div>
            <div class="slide-viewer" id="slide-container"></div>
            <div class="nav-bar">
                <div class="nav-progress" id="step-counter">1 / 5</div>
                <div class="nav-controls">
                    <button class="btn btn-ghost" onclick="engine.prev()"><i class="ph ph-arrow-up"></i></button>
                    <button class="btn" onclick="engine.next()">OK <i class="ph ph-arrow-down"></i></button>
                </div>
            </div>
        </div>

        <div id="screen-summary" class="screen">
            <h1 id="lbl-summary-title">Review & Send</h1>
            <p class="sub-text" id="lbl-summary-sub">Please verify the information below.</p>
            <div class="summary-box" id="summary-content"></div>
            <div class="action-stack">
                <button onclick="actions.sendEmail()" class="btn btn-action" id="btn-send-email"><i class="ph ph-envelope-simple"></i> Email (Preferred)</button>
                <button onclick="actions.sendWhatsapp()" class="btn btn-action btn-whatsapp" id="btn-send-wa"><i class="ph ph-whatsapp-logo"></i> WhatsApp</button>
                <button onclick="actions.copyText()" class="btn btn-action btn-copy" id="btn-copy"><i class="ph ph-copy"></i> Copy Text</button>
                <button onclick="app.reset()" class="btn btn-ghost" style="margin-top:10px;" id="btn-restart">Done</button>
            </div>
        </div>

    </div>

<script>
    // --- DATA: CLINICS ---
    const CLINICS_DATA = [
    {
        "Clinic Name": "Clinica Avicena",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "BEIRA",
        "Address": "Av. Poder Popular, Bairro Esturro,Av. Poder Popular, Bairro Esturro",
        "Phone Number": "258847494133",
        "Email Address": "avicena.clinic@intra.co.mz",
        "Plus Code": "5R9P+H2Q, Beira",
        "Google Maps Link": "https://maps.app.goo.gl/yPxSnvjEFdQV3WQF8"
    },
    {
        "Clinic Name": "Clinica M.M.Q",
        "Type of Clinic": "Hospital",
        "CIty": "BEIRA",
        "Address": "RUA ALFREDO LAWLY - ESTURRO, BEIRA TALHAO No.39,RUA ALFREDO LAWLY - ESTURRO, BEIRA TALHAO No.39",
        "Phone Number": "258847327026",
        "Email Address": "clinicaMMQ@gmail.com",
        "Plus Code": "5RCW+4V Beira",
        "Google Maps Link": "https://maps.app.goo.gl/eTAxKX9bToP1MKm49"
    },
    {
        "Clinic Name": "Lac, Lda - Clinica And Laboratorio De Analises Clinicas-Lac,Lda [Beira]",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "BEIRA",
        "Address": "RUA AIRES DE ORNELAS,RUA AIRES DE ORNELAS",
        "Phone Number": "2583326761",
        "Email Address": "lac@lac.co.mz",
        "Plus Code": "",
        "Google Maps Link": ""
    },
    {
        "Clinic Name": "Lenmed Private Hospital - Lt Clinica Medica,Limitada",
        "Type of Clinic": "Hospital",
        "CIty": "BEIRA",
        "Address": "Estoril, Rua Carlos Pereira,Estoril, Rua Carlos Pereira",
        "Phone Number": "258842613432",
        "Email Address": "info@clinicalt.co.mz",
        "Plus Code": "5VFX+F6, Beira",
        "Google Maps Link": "https://maps.app.goo.gl/kWHpKnsLuYUyQssU9"
    },
    {
        "Clinic Name": "Centro Medico Esperanca",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "CHIMOIO",
        "Address": "TALHAO 12&17 BAIRRO CENTRO HIPICO,TALHAO 12&17 BAIRRO CENTRO HIPICO",
        "Phone Number": "258823787307",
        "Email Address": "SeRGIO.SjDCONSULT@GMAIL.COM",
        "Plus Code": "VFV6+R82, Bairro Centro H√≠pico, Chimoio",
        "Google Maps Link": "https://maps.app.goo.gl/Q71npY8g1ytEKE8W6"
    },
    {
        "Clinic Name": "Clinica Fatima",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "CHIMOIO",
        "Address": "Av. Do Trabalho,Av. Do Trabalho",
        "Phone Number": "25825123669",
        "Email Address": "clinicafatima00@gmail.com",
        "Plus Code": "VFPH+GH Chimoio",
        "Google Maps Link": "https://maps.app.goo.gl/nbLACHdnbSVndRLs9"
    },
    {
        "Clinic Name": "Clinica Mais Saude",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "LICHINGA",
        "Address": "Unnamed Road, Lichinga, Mozambique,Unnamed Road, Lichinga, Mozambique",
        "Phone Number": "258873336677",
        "Email Address": "clinicamaissaude.mz@gmail.com",
        "Plus Code": "P6JV+2F Lichinga",
        "Google Maps Link": "https://maps.app.goo.gl/AMBvq38q2qR5JxM89"
    },
    {
        "Clinic Name": "Atlas Medclinic",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "MATEMA",
        "Address": "Mall de Tete Loja 06, Bairro Chingodzi, Matema,Mall de Tete Loja 06, Bairro Chingodzi, Matema",
        "Phone Number": "258870337108",
        "Email Address": "",
        "Plus Code": "RHQR+43 Tete",
        "Google Maps Link": "https://maps.app.goo.gl/GgdqeCEidf4wCx6W7"
    },
    {
        "Clinic Name": "Centro Medico Girassol",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "MOATIZE",
        "Address": "Rua EN7 pr√≥ximo da paragem Matxiqui-txiqui EN7, Bairro Chitata,EN7, Bairro Chitata",
        "Phone Number": "258869518444",
        "Email Address": "centromedicogirassollda@gmail.com",
        "Plus Code": "",
        "Google Maps Link": ""
    },
    {
        "Clinic Name": "Consultorio Saude Agora",
        "Type of Clinic": "Consultor",
        "CIty": "NACALA",
        "Address": "Av. Eduardo Mondlane, Bairro Bloco 1, Cidade Alta,Av. Eduardo Mondlane, Bairro Bloco 1, Cidade Alta",
        "Phone Number": "258872400014",
        "Email Address": "",
        "Plus Code": "CMVP+CF Nacala",
        "Google Maps Link": "https://maps.app.goo.gl/3jVcydfhmrZ6ukfL6"
    },
    {
        "Clinic Name": "Higia Consultorios Medicos",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "NACALA",
        "Address": "Bairro Bloco I, Avenida Julius Nyerere, N189,Bairro Bloco I, Avenida Julius Nyerere, N189",
        "Phone Number": "258847999988",
        "Email Address": "admin@Higiacm.com",
        "Plus Code": "CMVR+J2M, Julius Nyerere Road, Nacala",
        "Google Maps Link": "https://maps.app.goo.gl/nrYeYS7YVhWE6TpJ7"
    },
    {
        "Clinic Name": "Lac, Lda - Clinica And Laboratorio De Analises Clinicas-Lac,Lda [Nacala]",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "NACALA",
        "Address": "Nacala,Nacala",
        "Phone Number": "25826520391",
        "Email Address": "lac@lac.co.mz",
        "Plus Code": "CMRQ+GH4, Nacala",
        "Google Maps Link": "https://maps.app.goo.gl/XPK72x3zM9sNnNb4A"
    },
    {
        "Clinic Name": "Nacala Healthcare",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "NACALA",
        "Address": "Av. Eduardo Mondlane, Cidade baixa,Av. Eduardo Mondlane, Cidade baixa",
        "Phone Number": "25884/87 911 0110",
        "Email Address": "nacalaHealtHcare@gmail.com",
        "Plus Code": "FM4H+HQ, Nacala",
        "Google Maps Link": "https://maps.app.goo.gl/nUqaQJ8m5eHHiqvr7"
    },
    {
        "Clinic Name": "Clinica Muahivire",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "NAMPULA",
        "Address": "Av. Samora Machel, 502,Av. Samora Machel, 502",
        "Phone Number": "25884/823 930 004",
        "Email Address": "clinicmuaHivire@gmail.com",
        "Plus Code": "V7F7+9J Nampula",
        "Google Maps Link": "https://maps.app.goo.gl/VSMu6SStQC8rzoaD7"
    },
    {
        "Clinic Name": "Clinica Shifaa, Lda",
        "Type of Clinic": "Hospital",
        "CIty": "NAMPULA",
        "Address": "Av. Maguiguana No 1949,Av. Maguiguana No 1949",
        "Phone Number": "258844773662",
        "Email Address": "SHIFAACONTAB@GMAIL.COM",
        "Plus Code": "",
        "Google Maps Link": ""
    },
    {
        "Clinic Name": "Clinica Universitaria Lurio",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "NAMPULA",
        "Address": "Bairro Marrere, Rua 4250,Bairro Marrere, Rua 4250",
        "Phone Number": "258872400014",
        "Email Address": "",
        "Plus Code": "V6M2+3H5, Nampula",
        "Google Maps Link": "https://maps.app.goo.gl/fJZRaxXGur1eQ59j8"
    },
    {
        "Clinic Name": "Consultorio Medico Vossa Saude",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "NAMPULA",
        "Address": "Rua Muetasse, 2533 Bairro De Muahivire,Rua Muetasse, 2533 Bairro De Muahivire",
        "Phone Number": "258878238455",
        "Email Address": "clvosaude@gmail.com",
        "Plus Code": "V6M2+FP6, Unnamed Road, Nampula",
        "Google Maps Link": "https://maps.app.goo.gl/6AyzdkTqbL5wqEhy9"
    },
    {
        "Clinic Name": "Consultrio Medico Arco Iris",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "NAMPULA",
        "Address": "Av. Josina Machel,Av. Josina Machel",
        "Phone Number": "",
        "Email Address": "",
        "Plus Code": "V7H5+QR Nampula",
        "Google Maps Link": "https://maps.app.goo.gl/3EsFU3hJZiJJEW6d6"
    },
    {
        "Clinic Name": "Hospital Sorriso Privado",
        "Type of Clinic": "Hospital",
        "CIty": "NAMPULA",
        "Address": "Rua de Sofala,Rua de Sofala",
        "Phone Number": "25884/86 956 0001",
        "Email Address": "geral@Hospitalprivadosorriso.co.mz",
        "Plus Code": "V7F6+5C Nampula",
        "Google Maps Link": "https://maps.app.goo.gl/pGp3W3QBjGeBRwu26"
    },
    {
        "Clinic Name": "Lac, Lda - Clinica And Laboratorio De Analises Clinicas-Lac,Lda [Nampula]",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "NAMPULA",
        "Address": "Avenida Josina Machel,Avenida Josina Machel",
        "Phone Number": "2583213995",
        "Email Address": "lac@lac.co.mz",
        "Plus Code": "V7F9+8FX, Nampula",
        "Google Maps Link": "https://maps.app.goo.gl/nVZ4W4neRBhozpRR7"
    },
    {
        "Clinic Name": "Centro Medico Embondeiro",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "PEMBA",
        "Address": "Estrada Nacional No.106, Centro Comercial Da China, Loja 1, Bairro Alto Gingone,Estrada Nacional No.106, Centro Comercial Da China, Loja 1, Bairro Alto Gingone",
        "Phone Number": "258821641927",
        "Email Address": "info@cmembondeiro.com",
        "Plus Code": "2G2J+75 Pemba",
        "Google Maps Link": "https://maps.app.goo.gl/BMoHf8RgguP1Q2ubA"
    },
    {
        "Clinic Name": "Centro Medico Pro Vida",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "PEMBA",
        "Address": "Av. Marginal - Bairro Eduardo Mondlane , Pemba,Av. Marginal - Bairro Eduardo Mondlane , Pemba",
        "Phone Number": "258849888532",
        "Email Address": "recepcao@provida.co.mz",
        "Plus Code": "2HJ4+RV Pemba",
        "Google Maps Link": "https://maps.app.goo.gl/NxMZwc3z8JR8SVn2A"
    },
    {
        "Clinic Name": "Centro Medico Reviver,E.I",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "QUELIMANE",
        "Address": "Av. Julius Nyerere N 1017,Av. Julius Nyerere N 1017",
        "Phone Number": "258866120200",
        "Email Address": "cm.reviver@gmail.com",
        "Plus Code": "",
        "Google Maps Link": ""
    },
    {
        "Clinic Name": "Consultorio Bons Sinais",
        "Type of Clinic": "Consultor",
        "CIty": "QUELIMANE",
        "Address": "Av. 7 de Setembro, 516,Av. 7 de Setembro, 516",
        "Phone Number": "258872229222",
        "Email Address": "",
        "Plus Code": "4VCV+H2 Quelimane",
        "Google Maps Link": "https://maps.app.goo.gl/KHFPzAg1oYrUFr8d6"
    },
    {
        "Clinic Name": "Centro Home Care",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "TETE",
        "Address": "Av. Kenneth Kaunda, Ntali shopping,Av. Kenneth Kaunda, Ntali shopping",
        "Phone Number": "258843434555",
        "Email Address": "",
        "Plus Code": "",
        "Google Maps Link": ""
    },
    {
        "Clinic Name": "Centro Medico Embondeiro",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "TETE",
        "Address": "BAIRRO CHINGODZI, TETE,BAIRRO CHINGODZI, TETE",
        "Phone Number": "258821641927",
        "Email Address": "secretaria.cembondeiro@gmail.com",
        "Plus Code": "VJ7F+8G Tete",
        "Google Maps Link": "https://maps.app.goo.gl/AqcLCU77zv3ssVpx7"
    },
    {
        "Clinic Name": "Centro Medico Maxi Vida - MOATIZE",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "TETE",
        "Address": "Bairri Chipanga. Estrada Nacional No. 7 - Vila De Moatize,Bairri Chipanga. Estrada Nacional No. 7 - Vila De Moatize",
        "Phone Number": "25825220014",
        "Email Address": "cmaxvida.cont@gmail.com",
        "Plus Code": "",
        "Google Maps Link": ""
    },
    {
        "Clinic Name": "Centro Medico Maxi Vida - Sede",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "TETE",
        "Address": "Estrada Da Visao Mundial,Estrada Da Visao Mundial",
        "Phone Number": "25825220014",
        "Email Address": "cmaxivida@gmail.com",
        "Plus Code": "",
        "Google Maps Link": "https://maps.app.goo.gl/cPJPSST7bzC7NRBu9"
    },
    {
        "Clinic Name": "Centro Medico Maxi Vida - TETE CITY",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "TETE",
        "Address": "AV. EDUARDO MONDLANE,AV. EDUARDO MONDLANE",
        "Phone Number": "258852470488",
        "Email Address": "cmaxivida.limao@gmail.com",
        "Plus Code": "VJ84+VHC, Tete",
        "Google Maps Link": "https://maps.app.goo.gl/t8Bq39nLnw6VZbAq6"
    },
    {
        "Clinic Name": "Centro Medico Okapi, Limitada",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "TETE",
        "Address": "BAIRRO SAMORA MACHEL/CANONGOLA, ENZ, CIDADE DE TETE,BAIRRO SAMORA MACHEL/CANONGOLA, ENZ, CIDADE DE TETE",
        "Phone Number": "258861132971 / 4761431",
        "Email Address": "centromokapi@gmail.com",
        "Plus Code": "RH4Q+4C3, Tete",
        "Google Maps Link": "https://maps.app.goo.gl/pn4A7bxMEp7f9Lwc6"
    },
    {
        "Clinic Name": "Centro Medico Santa Victoria",
        "Type of Clinic": "Hospital",
        "CIty": "TETE",
        "Address": "EN7, Bairro Matundo,EN7, Bairro Matundo",
        "Phone Number": "258820466062",
        "Email Address": "recepcao@cmsv.co.mz",
        "Plus Code": "VJ43+8W Tete",
        "Google Maps Link": "https://maps.app.goo.gl/T6RxbTpCZkH6ptV46"
    },
    {
        "Clinic Name": "Clinica Bom Sucesso",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "TETE",
        "Address": "Bairro Chingodze, EN7,Bairro Chingodze, EN7",
        "Phone Number": "258846372050",
        "Email Address": "info@clinicabomsucesso.co.mz",
        "Plus Code": "VJ9G+VRQ, Tete",
        "Google Maps Link": "https://maps.app.goo.gl/DwurodgSakG8asVB7"
    },
    {
        "Clinic Name": "Consultorio Medico Fonte Vida",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "TETE",
        "Address": "EN7- Bairro Samora Machel,EN7- Bairro Samora Machel",
        "Phone Number": "258871321560",
        "Email Address": "recepcaocmfv@gmail.com",
        "Plus Code": "",
        "Google Maps Link": ""
    },
    {
        "Clinic Name": "Consultorio Medico Terra Rio,Lda",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "TETE",
        "Address": "Bairro Matundo, EN7,Bairro Matundo, EN7",
        "Phone Number": "258874444469",
        "Email Address": "consultoriomedicoterrario@gmail.com",
        "Plus Code": "",
        "Google Maps Link": ""
    },
    {
        "Clinic Name": "Laboratorio De Diagnostico Clinico De Tete",
        "Type of Clinic": "Laborat√≥rio",
        "CIty": "TETE",
        "Address": "BAIRRO FILIPE SAMUEL MAGAIA,BAIRRO FILIPE SAMUEL MAGAIA",
        "Phone Number": "233232336201",
        "Email Address": "laboratoriodiagclinicodetete@gmail.com",
        "Plus Code": "VH2F+5M2, Tete",
        "Google Maps Link": "https://maps.app.goo.gl/SZnLzwrBXctJBSFE8"
    },
    {
        "Clinic Name": "Lac, Lda - Clinica And Laboratorio De Analises Clinicas-Lac,Lda [Tete]",
        "Type of Clinic": "Policl√≠nica - Grupo de m√©dicos com laborat√≥rio, raio-X e instala√ß√µes para tratamento.",
        "CIty": "TETE",
        "Address": "Avenida Josina Machel,Avenida Josina Machel",
        "Phone Number": "25825242302",
        "Email Address": "lac@lac.co.mz",
        "Plus Code": "",
        "Google Maps Link": ""
    }
    ];

    // --- TRANSLATIONS ---
    const STRINGS = {
        en: {
            title: "GOP Request", subtitle: "Select an Administrator to begin.", newAdmin: "New Admin",
            summaryTitle: "Review & Send", summarySub: "Please verify the information below.",
            btnEmail: "Email (Preferred)", btnWa: "WhatsApp", btnCopy: "Copy Text", btnRestart: "Done",
            greeting: "Greetings,", intro: "Please find the necessary information below for our GOP request:", regards: "Regards,",
            reqName: "Requestor Name", reqRole: "Requestor Role", reqPhone: "Requestor Phone",
            patName: "Patient Name", aetnaId: "Aetna ID", patDob: "Date of Birth", illness: "Illness/Injury",
            servType: "Service Type", servDate: "Service Date", facName: "Facility Name", facAddr: "Address",
            facPhone: "Phone", phyName: "Physician", ccEmails: "CC Emails", copySuccess: "Copied!",
            typeHere: "Type here...", otherMan: "Other / Manual Entry"
        },
        pt: {
            title: "Solicita√ß√£o GOP", subtitle: "Selecione um administrador para come√ßar.", newAdmin: "Novo Admin",
            summaryTitle: "Revisar e Enviar", summarySub: "Verifique as informa√ß√µes abaixo.",
            btnEmail: "E-mail (Preferido)", btnWa: "WhatsApp", btnCopy: "Copiar Texto", btnRestart: "Terminado",
            greeting: "Ol√°,", intro: "Seguem as informa√ß√µes necess√°rias para nossa solicita√ß√£o de GOP:", regards: "Atenciosamente,",
            reqName: "Solicitante", reqRole: "Cargo", reqPhone: "Telefone",
            patName: "Nome do Paciente", aetnaId: "ID Aetna", patDob: "Data de Nascimento", illness: "Doen√ßa/Les√£o",
            servType: "Tipo de Servi√ßo", servDate: "Data do Servi√ßo", facName: "Instala√ß√£o", facAddr: "Endere√ßo",
            facPhone: "Telefone", phyName: "M√©dico", ccEmails: "E-mails (CC)", copySuccess: "Copiado!",
            typeHere: "Digite aqui...", otherMan: "Outro / Entrada Manual"
        }
    };

    const ICONS = {
        male: 'üë®‚Äç‚öïÔ∏è', female: 'üë©‚Äç‚öïÔ∏è', stethoscope: '<i class="ph ph-stethoscope"></i>',
        aid: '<i class="ph ph-first-aid-kit"></i>', gear: '<i class="ph ph-user-gear"></i>', plus: '<i class="ph ph-plus"></i>'
    };

    // --- DEFAULT ADMINS ---
    const DEFAULT_ADMINS = [
        {
            name: "Elder Francisco Granja",
            role: "Conselheiro M√©dico da Miss√£o / Mission Health Advisor",
            email: "francisco.granja@missionary.org",
            phone: "+258 84 010 5212",
            location: "Beira, Mozambique",
            iconType: "male",
            iconHTML: ICONS.male
        },
        {
            name: "Sister Evelina Granja",
            role: "Conselheiro M√©dico da Miss√£o / Mission Health Advisor",
            email: "evelina.granja@missionary.org",
            phone: "+258 85 802 1089",
            location: "Beira, Mozambique",
            iconType: "female",
            iconHTML: ICONS.female
        }
    ];

    // --- APP ENGINE ---
    const app = {
        lang: 'en',
        // Modified initialization: If localstorage is null or empty, use DEFAULTS
        admins: JSON.parse(localStorage.getItem('gop_admins')) || DEFAULT_ADMINS,
        currentAdmin: null,
        editIndex: -1, 
        currentFlow: null, // 'gop' or 'admin'
        formData: {},
        generatedText: '',

        init: function() {
            // Safety check: if parsed array was empty [] (from a manual clear), force defaults again
            if(this.admins.length === 0) this.admins = DEFAULT_ADMINS;
            
            this.updateLabels();
            this.renderProfiles();
            // Try to restore session on load
            this.restoreSession();
        },

        // --- STATE MANAGEMENT ---
        saveSession: function() {
            const state = {
                screen: document.querySelector('.screen.active')?.id,
                lang: this.lang,
                adminIndex: this.currentAdmin ? this.admins.indexOf(this.currentAdmin) : -1,
                editIndex: this.editIndex,
                flow: this.currentFlow,
                answers: engine.answers,
                step: engine.index,
                formData: this.formData // For summary screen
            };
            localStorage.setItem('gop_session', JSON.stringify(state));
        },

        restoreSession: function() {
            const saved = JSON.parse(localStorage.getItem('gop_session'));
            if (!saved) return;

            // Restore Lang
            if(saved.lang) this.lang = saved.lang;
            this.updateLabels();

            // Restore Admin Context
            if(saved.adminIndex > -1) this.currentAdmin = this.admins[saved.adminIndex];
            this.editIndex = saved.editIndex;
            this.currentFlow = saved.flow;
            this.formData = saved.formData || {};

            // Route to correct screen
            if (saved.screen === 'screen-runner' && saved.flow) {
                // Restart engine at specific step
                const questions = saved.flow === 'admin' ? getAdminQuestions(this.lang) : getGopQuestions(this.lang);
                
                // We define a callback based on flow
                const cb = saved.flow === 'admin' ? this.finishAdminSave.bind(this) : this.showSummary.bind(this);
                
                // Initialize engine but override index
                engine.questions = questions;
                engine.callback = cb;
                engine.answers = saved.answers || {};
                engine.index = saved.step || 0;
                engine.render(); // Redraws inputs
                engine.update(); // Updates UI/Progress
                switchScreen('screen-runner');

            } else if (saved.screen === 'screen-summary') {
                this.showSummary(this.formData);
            }
        },

        clearSession: function() {
            localStorage.removeItem('gop_session');
            this.currentFlow = null;
        },

        toggleLang: function() {
            this.lang = this.lang === 'en' ? 'pt' : 'en';
            this.updateLabels();
            this.renderProfiles();
            this.saveSession();
        },

        updateLabels: function() {
            const s = STRINGS[this.lang];
            document.getElementById('lbl-title').innerText = s.title;
            document.getElementById('lbl-subtitle').innerText = s.subtitle;
            document.getElementById('lbl-summary-title').innerText = s.summaryTitle;
            document.getElementById('lbl-summary-sub').innerText = s.summarySub;
            document.getElementById('btn-send-email').innerHTML = `<i class="ph ph-envelope-simple"></i> ${s.btnEmail}`;
            document.getElementById('btn-send-wa').innerHTML = `<i class="ph ph-whatsapp-logo"></i> ${s.btnWa}`;
            document.getElementById('btn-copy').innerHTML = `<i class="ph ph-copy"></i> ${s.btnCopy}`;
            document.getElementById('btn-restart').innerText = s.btnRestart;
        },

        renderProfiles: function() {
            const list = document.getElementById('profile-list');
            list.innerHTML = '';
            
            this.admins.forEach((admin, idx) => {
                const card = document.createElement('div');
                card.className = 'profile-card';
                card.onclick = (e) => {
                    if(e.target.closest('.card-actions')) return;
                    this.selectAdmin(idx);
                };
                card.innerHTML = `
                    <div class="card-actions">
                        <div class="action-icon" onclick="app.editAdmin(${idx})"><i class="ph ph-pencil-simple"></i></div>
                        <div class="action-icon delete" onclick="app.deleteAdmin(${idx})"><i class="ph ph-trash"></i></div>
                    </div>
                    <div class="profile-icon">${admin.iconHTML}</div>
                    <div class="profile-name">${admin.name}</div>
                    <div class="profile-role">${admin.role}</div>
                `;
                list.appendChild(card);
            });

            const addBtn = document.createElement('div');
            addBtn.className = 'profile-card add-card';
            addBtn.onclick = () => this.startAdminFlow();
            addBtn.innerHTML = `
                <div class="profile-icon">${ICONS.plus}</div>
                <div class="profile-name">${STRINGS[this.lang].newAdmin}</div>
            `;
            list.appendChild(addBtn);
        },

        deleteAdmin: function(idx) {
            if(confirm(`${this.lang === "en" ? "Delete this profile?" : "Excluir este perfil?"}`)) {
                this.admins.splice(idx, 1);
                localStorage.setItem('gop_admins', JSON.stringify(this.admins));
                this.renderProfiles();
            }
        },

        editAdmin: function(idx) {
            this.editIndex = idx;
            this.currentFlow = 'admin';
            const data = this.admins[idx];
            const [code, ...rest] = data.phone.split(' ');
            const num = rest.join(' ');

            const prefill = {
                icon: data.iconType,
                name: data.name,
                role: data.role,
                email: data.email,
                phone_code: code,
                phone_num: num,
                location: data.location
            };
            
            engine.start(getAdminQuestions(this.lang), this.finishAdminSave.bind(this), prefill);
        },

        startAdminFlow: function() {
            this.editIndex = -1;
            this.currentFlow = 'admin';
            engine.start(getAdminQuestions(this.lang), this.finishAdminSave.bind(this));
        },

        finishAdminSave: function(data) {
            const newAdmin = {
                name: data.name,
                role: data.role,
                email: data.email,
                phone: `${data.phone_code} ${data.phone_num}`,
                location: data.location,
                iconType: data.icon,
                iconHTML: data.iconHTML 
            };

            if (this.editIndex >= 0) {
                this.admins[this.editIndex] = newAdmin;
            } else {
                this.admins.push(newAdmin);
                this.editIndex = this.admins.length - 1;
            }

            localStorage.setItem('gop_admins', JSON.stringify(this.admins));
            this.clearSession(); // Flow complete
            this.renderProfiles();
            this.selectAdmin(this.editIndex);
        },

        selectAdmin: function(idx) {
            this.currentAdmin = this.admins[idx];
            this.startGopFlow();
        },

        startGopFlow: function() {
            this.currentFlow = 'gop';
            engine.start(getGopQuestions(this.lang), this.showSummary.bind(this));
        },

        showSummary: function(data) {
            this.formData = data;
            // Ensure we save session here so if they reload on summary, they stay here
            this.saveSession();

            const s = STRINGS[this.lang];
            const container = document.getElementById('summary-content');
            container.innerHTML = '';
            
            const pCode = data.facPhone_code || '';
            const pNum = data.facPhone_num || '';
            const formattedFacPhone = pNum ? `${pCode} ${pNum}` : '';

            const addRow = (l, v) => { if(v) container.innerHTML += `<div class="summary-row"><div class="summary-label">${l}</div><div class="summary-val">${v}</div></div>`; };

            addRow(s.reqName, this.currentAdmin.name);
            addRow(s.reqRole, this.currentAdmin.role);
            addRow(s.reqPhone, this.currentAdmin.phone);
            addRow(s.patName, data.patientName);
            addRow(s.aetnaId, data.aetnaId);
            addRow(s.patDob, this.formatDate(data.dob));
            addRow(s.illness, data.illness);
            addRow(s.servType, data.serviceType);
            addRow(s.servDate, this.formatDate(data.serviceDate));
            addRow(s.facName, data.facName);
            addRow(s.facAddr, data.facAddress);
            addRow(s.facPhone, formattedFacPhone);
            addRow(s.phyName, data.phyName);
            addRow(s.ccEmails, data.ccEmail);

            this.generatedText = actions.generateFullText();
            switchScreen('screen-summary');
        },

        reset: function() { 
            this.clearSession();
            switchScreen('screen-home'); 
        },
        formatDate: function(iso) { if(!iso) return ''; const [y, m, d] = iso.split('-'); return `${m}/${d}/${y}`; }
    };

    // --- TYPEFORM ENGINE ---
    const engine = {
        questions: [], index: 0, answers: {}, callback: null,

        start: function(qs, cb, prefill = {}) {
            this.questions = qs;
            this.callback = cb;
            this.index = 0;
            this.answers = {...prefill};
            this.render();
            this.update();
            switchScreen('screen-runner');
            app.saveSession(); // Save start
        },

        render: function() {
            const phText = STRINGS[app.lang].typeHere;
            const c = document.getElementById('slide-container'); c.innerHTML = '';
            this.questions.forEach((q, i) => {
                const div = document.createElement('div'); div.className = 'slide'; div.id = `slide-${i}`;
                
                let val = this.answers[q.id] || q.defaultValue || '';

                let html = '';
                // Added oninput to save immediately
                if(q.type === 'text' || q.type === 'email') {
                    html = `<input type="${q.type}" id="in-${i}" value="${val}" placeholder="${phText}" autocomplete="off" oninput="engine.inputChange('${q.id}', this.value)">`;
                } else if(q.type === 'date') {
                    html = `<input type="date" id="in-${i}" value="${val}" oninput="engine.inputChange('${q.id}', this.value)">`;
                } else if(q.type === 'phone_complex') {
                    let code = this.answers[q.id+'_code'] || '+258';
                    let num = this.answers[q.id+'_num'] || '';
                    html = `
                        <div class="phone-row">
                            <select id="in-${i}-code" class="phone-select" onchange="engine.fmtPhone(${i}, '${q.id}')">
                                <option value="+258" ${code==='+258'?'selected':''}>üá≤üáø +258</option>
                                <option value="+27" ${code==='+27'?'selected':''}>üáøüá¶ +27</option>
                                <option value="+244" ${code==='+244'?'selected':''}>üá¶üá¥ +244</option>
                                <option value="+1" ${code==='+1'?'selected':''}>üá∫üá∏ +1</option>
                            </select>
                            <input type="tel" id="in-${i}-num" value="${num}" placeholder="84 123 4567" oninput="engine.fmtPhone(${i}, '${q.id}')">
                        </div>`;
                } else if(q.type === 'icon_select') {
                    const cur = this.answers['icon'];
                    const mkIcon = (k, h) => `<div class="icon-opt ${cur===k?'selected':''}" onclick="engine.selIcon(this, '${k}', '${h}')">${h}</div>`;
                    html = `<div class="icon-grid">
                        ${mkIcon('male', ICONS.male)} ${mkIcon('female', ICONS.female)}
                    </div><input type="hidden" id="in-${i}" value="${cur||''}">`;
                } else if(q.type === 'map_search') {
                    html = `<input type="text" id="in-${i}" value="${val}" placeholder="Address or GPS" oninput="engine.inputChange('${q.id}', this.value)">
                            <a href="#" class="map-helper" onclick="actions.openMap(event, 'in-${i}')"><i class="ph ph-map-pin"></i> Google Maps</a>`;
                } else if(q.type === 'clinic_select') {
                    // Sorting clinics by City then Name
                    const sortedClinics = [...CLINICS_DATA].sort((a, b) => {
                        const cityA = (a.CIty || "").toUpperCase();
                        const cityB = (b.CIty || "").toUpperCase();
                        if (cityA < cityB) return -1;
                        if (cityA > cityB) return 1;
                        return a['Clinic Name'].localeCompare(b['Clinic Name']);
                    });

                    // grouping
                    let options = `<option value="">Select...</option>`;
                    let currentCity = "";
                    sortedClinics.forEach(cl => {
                        const city = (cl.CIty || "Other").toUpperCase();
                        if(city !== currentCity) {
                            if(currentCity !== "") options += `</optgroup>`;
                            options += `<optgroup label="${city}">`;
                            currentCity = city;
                        }
                        const isSel = val === cl['Clinic Name'] ? 'selected' : '';
                        options += `<option value="${cl['Clinic Name']}" ${isSel}>${cl['Clinic Name']}</option>`;
                    });
                    if(currentCity !== "") options += `</optgroup>`;
                    
                    // Add manual option
                    options += `<option value="manual" ${val==='manual'?'selected':''}>${STRINGS[app.lang].otherMan}</option>`;

                    html = `<select id="in-${i}" class="clinic-dropdown" onchange="engine.selectClinic(${i}, this.value)">${options}</select>`;
                }

                div.innerHTML = `<h2>${q.label}</h2>${q.sub ? `<span class="sub-text">${q.sub}</span>` : ''}<div class="tf-input-group">${html}</div>`;
                c.appendChild(div);
            });
            document.onkeydown = (e) => { if(e.key === 'Enter') this.next(); };
        },

        // New helper to save as you type
        inputChange: function(key, val) {
            this.answers[key] = val;
            app.saveSession();
        },
        
        // AUTOFILL LOGIC
        selectClinic: function(i, val) {
            this.answers['facName'] = val; // Save selection to model
            
            if(val === 'manual' || val === '') {
                 // Clean for manual entry
                this.answers['facAddress'] = '';
                this.answers['facPhone_code'] = '+258';
                this.answers['facPhone_num'] = '';
            } else {
                // Find clinic data
                const c = CLINICS_DATA.find(x => x['Clinic Name'] === val);
                if(c) {
                    // 1. Set Address
                    let fullAddr = c.Address || '';
                    if(c['Google Maps Link']) fullAddr += `, ${c['Google Maps Link']}`;
                    this.answers['facAddress'] = fullAddr;

                    // 2. Parse Phone (Assuming mostly +258)
                    let rawPhone = (c['Phone Number'] || "").replace(/\D/g, ''); 
                    let pCode = '+258';
                    let pNum = rawPhone;

                    // Simple logic to detect if country code is included in string
                    if(rawPhone.startsWith('258')) {
                        pNum = rawPhone.substring(3);
                    } else if (rawPhone.startsWith('27')) {
                        pCode = '+27';
                        pNum = rawPhone.substring(2);
                    }
                    
                    this.answers['facPhone_code'] = pCode;
                    this.answers['facPhone_num'] = pNum;
                }
            }
            // Re-render to propagate values to the (hidden) future slides or just save state
            // In this engine, we just save state. When the user clicks NEXT, the next slide will
            // initialize with the values we just set in this.answers.
            
            // However, we should also manually update the inputs in the DOM just in case the slides were already generated
            // Iterate through questions to find indices
            this.questions.forEach((q, idx) => {
                if(q.id === 'facAddress') {
                    const el = document.getElementById(`in-${idx}`);
                    if(el) el.value = this.answers['facAddress'] || '';
                }
                if(q.id === 'facPhone') {
                    const elNum = document.getElementById(`in-${idx}-num`);
                    const elCode = document.getElementById(`in-${idx}-code`);
                    if(elNum) elNum.value = this.answers['facPhone_num'] || '';
                    if(elCode) elCode.value = this.answers['facPhone_code'] || '+258';
                    // Trigger format logic
                    if(elNum) this.fmtPhone(idx, 'facPhone');
                }
            });

            app.saveSession();
        },

        update: function() {
            document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
            const s = document.getElementById(`slide-${this.index}`);
            if(s) {
                s.classList.add('active');
                setTimeout(() => { const i = s.querySelector('input:not([type=hidden]), select'); if(i) i.focus(); }, 100);
            }
            const p = ((this.index+1)/this.questions.length)*100;
            document.getElementById('progress-bar').style.width = `${p}%`;
            document.getElementById('step-counter').innerText = `${this.index+1} / ${this.questions.length}`;
            app.saveSession(); // Save on step change
        },

        next: function() {
            const q = this.questions[this.index];
            const i = this.index;
            let val = null, valid = true, el = null;

            if(q.type === 'phone_complex') {
                const c = document.getElementById(`in-${i}-code`).value;
                const n = document.getElementById(`in-${i}-num`).value.trim();
                el = document.getElementById(`in-${i}-num`);
                if(n.length < 5) valid = false;
                else { 
                    this.answers[q.id+'_code'] = c; 
                    this.answers[q.id+'_num'] = n; 
                    val='ok'; 
                }
            } else {
                el = document.getElementById(`in-${i}`);
                val = el.value.trim();
                if(q.type === 'email' && val) {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if(!emailRegex.test(val)) valid = false;
                }
                if(!q.optional && !val) valid = false;
                else this.answers[q.id] = val;
            }

            if(!valid && !q.optional) { 
                if(el) { 
                    el.classList.add('shake'); 
                    setTimeout(()=>el.classList.remove('shake'), 400); 
                } 
                return; 
            }

            if(this.index < this.questions.length-1) { 
                this.index++; 
                this.update(); 
            } else { 
                this.callback(this.answers);
            }
        },
        prev: function() { if(this.index>0){this.index--;this.update();} else app.reset(); },
        
        selIcon: function(e, k, h) {
            document.querySelectorAll('.icon-opt').forEach(x=>x.classList.remove('selected'));
            e.classList.add('selected');
            document.getElementById(`in-${this.index}`).value = k;
            this.answers['icon'] = k; // Update immediate
            this.answers['iconHTML'] = h;
            app.saveSession();
            setTimeout(()=>this.next(), 250);
        },
        
        fmtPhone: function(i, idKey) {
            const c = document.getElementById(`in-${i}-code`).value;
            const inp = document.getElementById(`in-${i}-num`);
            let v = inp.value.replace(/\D/g, '');
            if(c === '+258') {
                if(v.length>9) v=v.substring(0,9);
                if(v.length>5) v=`${v.substring(0,2)} ${v.substring(2,5)} ${v.substring(5)}`;
                else if(v.length>2) v=`${v.substring(0,2)} ${v.substring(2)}`;
            }
            inp.value = v;
            // Realtime save for phone
            this.answers[idKey+'_code'] = c;
            this.answers[idKey+'_num'] = v;
            app.saveSession();
        }
    };

    // --- HELPER ACTIONS ---
    const actions = {
        openMap: (e, id) => { e.preventDefault(); const v = document.getElementById(id).value; window.open(`https://maps.google.com/?q=${encodeURIComponent(v)}`); },
        generateFullText: () => {
            const d = app.formData, a = app.currentAdmin, s = STRINGS[app.lang];
            const L = (l, v) => `${l}: ${v || 'N/A'}`;
            const facPhone = d.facPhone_num ? `${d.facPhone_code} ${d.facPhone_num}` : 'N/A';

            return `${s.greeting}\n\n${s.intro}\n\n` +
                   `${L(s.reqName, a.name)}\n${L(s.reqRole, a.role)}\n${L(s.reqPhone, a.phone)}\n${L('Location', a.location)}\n` + 
                   `----------------\n` +
                   `${L(s.patName, d.patientName)}\n${L(s.aetnaId, d.aetnaId)}\n${L(s.patDob, app.formatDate(d.dob))}\n` +
                   `----------------\n` +
                   `${L(s.illness, d.illness)}\n${L(s.servType, d.serviceType)}\n${L(s.servDate, app.formatDate(d.serviceDate))}\n` +
                   `----------------\n` +
                   `${L(s.facName, d.facName)}\n${L(s.facAddr, d.facAddress)}\n${L(s.facPhone, facPhone)}\n` +
                   `${L(s.phyName, d.phyName)}\n${L('Specialty', d.phySpec)}\n` +
                   `----------------\n` +
                   `${L(s.ccEmails, d.ccEmail)}\n\n${s.regards}\n${a.name}`;
        },
        sendEmail: () => {
            app.clearSession(); // Clear on successful send intent
            window.location.href = `mailto:agb@mso.co.za?subject=${encodeURIComponent('GOP Request: '+app.formData.patientName)}&body=${encodeURIComponent(app.generatedText)}`;
        },
        sendWhatsapp: () => {
            app.clearSession(); // Clear on successful send intent
            window.open(`https://wa.me/27662903409?text=${encodeURIComponent(app.generatedText)}`);
        },
        copyText: () => navigator.clipboard.writeText(app.generatedText).then(() => {
            const b = document.getElementById('btn-copy'); const old = b.innerHTML;
            b.innerHTML = `<i class="ph ph-check"></i> ${STRINGS[app.lang].copySuccess}`;
            setTimeout(()=>b.innerHTML=old, 2000);
            app.clearSession(); // Clear on copy success
        })
    };

    function switchScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); app.saveSession(); }

    // --- DATA GENERATORS ---
    function getAdminQuestions(l) {
        const en = l==='en';
        return [
            { id: 'icon', type: 'icon_select', label: en?'Choose Icon':'Escolha um √≠cone', sub: en?'Pick an avatar for your profile':'Escolha um avatar para seu perfil' },
            { id: 'name', type: 'text', label: en?'Your Name':'Seu Nome', sub: en?'Mission Contact Name':'Nome do Contato da Miss√£o' },
            { id: 'role', type: 'text', label: en?'Your Role':'Seu Cargo', sub: en?'Ex: Mission Nurse':'Ex. Medico da Miss√£o' },
            { id: 'email', type: 'email', label: en?'Your Email':'Seu E-mail', sub: en?'churchofjesuschrist.org or missionary.org':'churchofjesuschrist.org ou missionary.org' },
            { id: 'phone', type: 'phone_complex', label: en?'Your Phone':'Seu Telefone', sub: en?'Select Country Code':'Selecione o C√≥digo do Pa√≠s' },
            { id: 'location', type: 'text', label: en?'Your Location':'Sua Localiza√ß√£o', sub: 'City, Country', defaultValue: 'Beira, Mozambique' }
        ];
    }
    function getGopQuestions(l) {
        const en = l==='en';
        return [
            { id: 'patientName', type: 'text', label: en?'Missionary/Patient‚Äôs FULL Name':'Nome COMPLETO do Mission√°rio/Paciente', sub: en?'First & Last':'Nome e Sobrenome' },
            { id: 'aetnaId', type: 'text', label: 'Aetna W ID #', sub: '' },
            { id: 'dob', type: 'date', label: en?'Missionary/Patient‚Äôs Date of Birth':'Data de Nascimento', sub: '' },
            { id: 'illness', type: 'text', label: en?'What is the nature of the illness/injury/medical complaint':'Qual √© a natureza da doen√ßa/les√£o/queixa m√©dica', sub: en?'(A brief explanation of symptoms. Ex. Knee pain, sore throat, abdominal pain, etc.):': 'Uma breve explica√ß√£o dos sintomas. Ex. Dor no joelho, dor de garganta, dor abdominal, etc.' },
            { id: 'serviceType', type: 'text', label: en?'Service Needed':'Servi√ßo Necess√°rio', sub: en?'ex: MD consult, ER visit, Hosptial Admission, etc.' : 'ex. consulta m√©dica, visita ao pronto-socorro, interna√ß√£o hospitalar, etc.' },
            { id: 'serviceDate', type: 'date', label: en?'Date of Service':'Data do Servi√ßo', sub: en?'planned or emergency' : 'planejada ou emergencial' },
            
            // UPDATED: Changed from 'text' to 'clinic_select'
            { id: 'facName', type: 'clinic_select', label: en?'Facility Name':'Nome da Instala√ß√£o/Provedor', sub: en? "Select from list or choose 'Manual Entry' for new clinics" : 'Selecione na lista ou escolha "Entrada Manual"' },
            
            { id: 'facAddress', type: 'map_search', label: en?'Facility/Provider address/GPS location':'Endere√ßo da instala√ß√£o/provedor/localiza√ß√£o GPS:', sub: '' },
            { id: 'facPhone', type: 'phone_complex', label: en?'Facility Phone':'Telefone do Hospital', sub: en?'Reception/ER':'Recep√ß√£o/Emerg√™ncia' },
            { id: 'phyName', type: 'text', label: en?'Physician Name':'Nome do M√©dico', sub: en?'Optional - If known':'Opcional - se conhecido', optional: true },
            { id: 'phySpec', type: 'text', label: en?'Specialty':'Especialidade', sub: en?'Optional If known':'Opcional - se conhecida', optional: true },
            { id: 'ccEmail', type: 'text', label: en?"Email Address(es) of any other contacts who should receive a copy of the GOP when issued:" :'Endere√ßo(s) de e-mail de quaisquer outros contatos que dever√£o receber uma c√≥pia do GOP quando emitido: ', sub: en?'Separate with commas. Optional.':'Separe por v√≠rgulas. Opcional', optional: true }
        ];
    }

    // Start
    app.init();

</script>
</body>
</html>